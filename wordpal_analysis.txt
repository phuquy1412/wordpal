Phân Tích Luồng Hoạt Động Dự Án WordPal (Backend)

Đây là tài liệu phân tích tổng quan về cấu trúc và luồng hoạt động của phần backend trong dự án WordPal.

---

### 1. Khởi tạo Server

- **Điểm vào chính**: Toàn bộ ứng dụng backend bắt đầu từ file `backend/src/server.js`.
- **Framework**: Sử dụng `Express.js` để xây dựng server và quản lý các API endpoint.
- **Cổng (Port)**: Server lắng nghe các kết nối ở cổng được định nghĩa trong biến môi trường `process.env.PORT`. Nếu biến này không tồn tại, server sẽ mặc định chạy ở cổng `5001`.
- **Thứ tự khởi động**: Một điểm quan trọng là server chỉ bắt đầu chạy và lắng nghe yêu cầu sau khi đã kết nối thành công tới cơ sở dữ liệu MongoDB.

---

### 2. Kết nối Cơ sở dữ liệu (Database)

- **File cấu hình**: Việc kết nối tới MongoDB được quản lý tại file `backend/src/config/db.js`.
- **Thư viện**: Sử dụng `Mongoose` để giao tiếp với MongoDB, cho phép định nghĩa cấu trúc dữ liệu (Schema) và thực hiện các câu truy vấn một cách dễ dàng.
- **Chuỗi kết nối**: Chuỗi kết nối đến cơ sở dữ liệu (MongoDB Atlas) được lấy từ biến môi trường `process.env.MONGODB_CONECTION_STRING`. Cách làm này giúp bảo mật thông tin nhạy cảm.
- **Xử lý lỗi**: Nếu kết nối thất bại, ứng dụng sẽ tự động dừng lại để tránh các lỗi phát sinh không mong muốn.

---

### 3. Luồng xử lý của một API Request (API Flow)

Ứng dụng được xây dựng theo kiến trúc REST API với mô hình gần giống MVC (Model-View-Controller), chia tách rõ ràng các thành phần. Dưới đây là luồng xử lý của một yêu cầu API điển hình, ví dụ khi người dùng đã đăng nhập và muốn lấy thông tin cá nhân (`GET /api/user/me`):

1.  **Request đến Server**: Client gửi yêu cầu `GET` đến `http://<your-domain>/api/user/me` kèm theo một `Authorization` header chứa token JWT.

2.  **Server (`server.js`)**:
    - Nhận yêu cầu.
    - Dựa vào đường dẫn `/api/user`, nó chuyển tiếp yêu cầu này đến bộ định tuyến (router) tương ứng là `usersRouter` (được import từ `backend/src/routers/usersRouters.js`).

3.  **Router (`usersRouters.js`)**:
    - File này định nghĩa các điểm cuối (endpoint) cho tài nguyên người dùng.
    - Nó thấy yêu cầu khớp với `router.get('/me', ...)`.
    - Trước khi gọi hàm xử lý logic, nó yêu cầu chạy một `middleware` tên là `protect`.

4.  **Middleware (`authMiddleware.js`)**:
    - Hàm `protect` trong file này được thực thi.
    - Nó đọc `Authorization` header, lấy ra token JWT.
    - Nó giải mã và xác thực token.
    - Nếu token hợp lệ, nó dùng `User Model` để tìm người dùng tương ứng trong cơ sở dữ liệu và **gắn thông tin người dùng vào đối tượng `req.user`**.
    - Sau khi xong, nó chuyển quyền điều khiển (pass control) cho bước tiếp theo.

5.  **Controller (`usersControllers.js`)**:
    - Hàm `getMe` trong file này được gọi.
    - Hàm này có thể truy cập vào `req.user` (đã được middleware `protect` cung cấp).
    - Nó sử dụng `User Model` để lấy thông tin chi tiết của người dùng từ ID (`req.user.id`).
    - Cuối cùng, nó tạo một phản hồi JSON chứa thông tin người dùng và gửi về cho client.

6.  **Model (`User.js`)**:
    - File này định nghĩa "bản thiết kế" (Schema) cho dữ liệu người dùng trong MongoDB.
    - Nó quy định các trường dữ liệu như `name`, `email`, `password`,...
    - Nó cũng chứa các logic tự động, ví dụ như một `hook pre-save` để tự động băm (hash) mật khẩu bằng `bcrypt` trước khi lưu vào cơ sở dữ liệu.
    - `Mongoose Model` được tạo từ Schema này chính là công cụ để Controller tương tác với collection `users` trong DB.

---

### 4. Các Chức năng chính (Dựa trên cấu trúc file)

Dựa vào các tệp controllers và models, có thể thấy các nhóm chức năng chính của ứng dụng bao gồm:

- **Auth**: Đăng ký, đăng nhập, quản lý token.
- **Users**: Quản lý thông tin người dùng.
- **Words & Topics**: Quản lý các từ vựng và chủ đề học.
- **Flashcards**: Tạo và quản lý các bộ flashcard.
- **Quizzes**: Tạo và xử lý kết quả các bài quiz.
- **Statistics**: Thống kê tiến độ học tập của người dùng.
- **Study Schedules & Sessions**: Quản lý lịch học và các phiên học.
- **Reminders**: Lên lịch và gửi email nhắc nhở học tập (thông qua `services/reminderScheduler.js`).
